## 现状定位

* 社区“发帖后看不到”高概率来自数据源不一致：公共社区走后端 API，而高校控制台“帖子治理”仍读 localStorage 原型数据；校内社区还存在权限/话题过滤导致“看不到”的情况。相关：[/frontend/app/community/page.tsx](file:///d:/Trae/333/cloud-edu-match-platform-design/frontend/app/community/page.tsx)、[/frontend/app/campus/community/page.tsx](file:///d:/Trae/333/cloud-edu-match-platform-design/frontend/app/campus/community/page.tsx)、[/frontend/lib/client-store.ts](file:///d:/Trae/333/cloud-edu-match-platform-design/frontend/lib/client-store.ts)

* 通知已支持 read\_at，但没有“未读总数”接口；会话系统没有“已读游标/未读数”模型与接口，因此无法实现会话未读角标。相关：[/backend/app/api/v1/endpoints/notifications.py](file:///d:/Trae/333/cloud-edu-match-platform-design/backend/app/api/v1/endpoints/notifications.py)、[/backend/app/api/v1/endpoints/conversations.py](file:///d:/Trae/333/cloud-edu-match-platform-design/backend/app/api/v1/endpoints/conversations.py)

* 首页“最近的辅导”目前是 mock 数据，未与真实会话（匹配接单后创建的会话）挂钩。相关：[/frontend/app/home/page.tsx](file:///d:/Trae/333/cloud-edu-match-platform-design/frontend/app/home/page.tsx#L95-L98)

## 目标（按你的 3 点逐条落地）

### 1) 社区发帖后可见（完善社区）

* 统一数据源：高校控制台“帖子治理”改为读取后端真实 campus posts（而不是 localStorage）。

* 列表刷新：公共社区/校内社区发布成功后，除本地 prepend 外再做一次服务端 re-fetch（或至少在返回失败时回滚并提示），确保“刷新后仍可见”。

* 校内社区过滤一致性：明确“全部/话题”筛选时新帖的 topic\_ids 处理（避免被前端筛选误隐藏）。

* 补齐空态与错误提示：发布失败/权限 403 给出可理解提示（如“请先完成高校学生认证/加入本校”）。

### 2) 通知/会话未读与角标（button + span）

* 通知：新增未读总数接口

  * `GET /api/v1/notifications/unread-count -> { unread_count }`

  * 保持现有列表接口不改结构。

* 会话：引入已读游标并返回未读

  * 数据层：在 ConversationParticipant 增加 `last_read_at`（或 `last_read_message_id`，二选一；优先 last\_read\_at 实现简单）。

  * 接口：

    * `POST /api/v1/conversations/{id}/read`（打开会话/进入消息页时调用）

    * `GET /api/v1/conversations` 返回每个会话的 `unread_count`

    * `GET /api/v1/conversations/unread-count` 返回 `unread_conversations_count`（按“有未读的会话个数”统计）

* 前端展示：

  * Navbar：

    * “消息”按钮右侧 span 显示总未读 = 未读通知 + 未读会话个数

    * 另加一个“通知”入口按钮（或在现有消息按钮中拆分），旁边 badge 显示未读通知数

  * 消息页 Tabs：

    * “通知”tab 标题旁 badge 显示未读通知数

    * “会话”tab 标题旁 badge 显示未读会话个数

  * 通知页：做“未读/已读”分组或增加筛选（默认先显示未读）。

### 3) 首页“最近的辅导”数据化（div）

* 用真实会话替代 mock：

  * 首页加载时拉取 `/conversations?limit=…`（或复用现有 `/conversations` 返回）

  * 在“最近的辅导”卡片中展示最近 N 个会话：对端姓名/角色、最后消息摘要、最后消息时间；点击直达 `/chat/{id}`

  * 数据优先从“匹配接单创建的会话”来（若 payload 里带 match\_request\_id，可在 UI 标注“来自匹配”）。

## 需要修改的文件范围（高层）

* 先按规则更新验收口径：[/spec.md](file:///d:/Trae/333/cloud-edu-match-platform-design/spec.md)

* 后端：notifications unread-count、conversations read/unread、必要的模型迁移/字段

* 前端：Navbar 角标、messages 页 tab badge/分组、home 页最近辅导、community/campus/community 以及 university dashboard 帖子治理的数据源

## 验证（每次改动后只测最新相关点）

* Playwright 新增/更新用例：

  * 社区：发帖后在列表可见（公共社区 + 校内社区）

  * 未读：通知未读数、会话未读会话个数、Navbar 角标正确变化

  * 最近辅导：接单建立会话后首页“最近的辅导”可见并可跳转会话

